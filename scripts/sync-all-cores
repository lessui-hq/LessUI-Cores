#!/usr/bin/env ruby
# frozen_string_literal: true

# Sync all cores across all CPU families for SD card compatibility
# Ensures every core exists on every platform, even if too slow on some

require 'yaml'
require 'fileutils'

CPU_FAMILIES = %w[cortex-a7 cortex-a53 cortex-a55 cortex-a76]

def load_recipe(cpu)
  file_content = File.read("recipes/linux/#{cpu}.yml")
  yaml_content = file_content.split('---', 2)[1]
  YAML.load(yaml_content) || {}
end

def save_recipe(cpu, recipes)
  recipe_file = "recipes/linux/#{cpu}.yml"
  header = File.read(recipe_file).split('---', 2).first

  File.open(recipe_file, 'w') do |f|
    f.write(header)
    f.write("---\n")
    f.write(YAML.dump(recipes))
  end
end

puts "Syncing all cores across all CPU families for SD card compatibility...\n\n"

# Load all recipes
all_recipes = {}
CPU_FAMILIES.each do |cpu|
  all_recipes[cpu] = load_recipe(cpu)
end

# Get union of all cores
all_cores = all_recipes.values.flat_map(&:keys).uniq.sort

puts "Total unique cores across all platforms: #{all_cores.size}"
puts ""

# For each CPU family, add missing cores
CPU_FAMILIES.each do |cpu|
  missing = all_cores - all_recipes[cpu].keys

  if missing.empty?
    puts "#{cpu}: ✓ Already has all #{all_cores.size} cores"
  else
    puts "#{cpu}: Adding #{missing.size} missing cores..."

    missing.each do |core|
      # Find this core in another CPU family
      source_cpu = all_recipes.find { |c, recipes| recipes.key?(core) }&.first

      if source_cpu
        all_recipes[cpu][core] = all_recipes[source_cpu][core].dup
        puts "  + #{core} (from #{source_cpu})"
      else
        puts "  ERROR: #{core} not found in any recipe!"
      end
    end

    # Sort alphabetically and save
    all_recipes[cpu] = all_recipes[cpu].sort.to_h
    save_recipe(cpu, all_recipes[cpu])
    puts "  ✓ Saved #{cpu}.yml (#{all_recipes[cpu].size} cores)"
  end
  puts ""
end

puts "✅ All CPU families now have identical core lists!"
puts "\nFinal counts:"
CPU_FAMILIES.each do |cpu|
  puts "  #{cpu}: #{all_recipes[cpu].size} cores"
end
