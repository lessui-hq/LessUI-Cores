#!/usr/bin/env ruby
# frozen_string_literal: true

# Add missing MinUI required cores to all CPU recipe files
# Ensures all 13 MinUI cores are available on all platforms for compatibility

require 'yaml'
require 'fileutils'

# MinUI core definitions
SUPAFAUST = {
  'version' => '75c658cce454e58ae04ea252f53a31c60d61548e',
  'commit' => '75c658cce454e58ae04ea252f53a31c60d61548e',
  'url' => 'https://github.com/libretro/supafaust/archive/75c658cce454e58ae04ea252f53a31c60d61548e.tar.gz',
  'license' => 'Non-commercial',
  'platform' => 'unix',
  'submodules' => false,
  'build_type' => 'make',
  'makefile' => 'Makefile',
  'name' => 'supafaust',
  'repo' => 'libretro-supafaust',
  'build_dir' => '.',
  'extra_args' => [],
  'cmake_opts' => [],
  'so_file' => 'mednafen_supafaust_libretro.so'
}

SNES9X2005 = {
  'version' => '1c9163ebabf1a5d454ff30221f7c735d7b286e25',
  'commit' => '1c9163ebabf1a5d454ff30221f7c735d7b286e25',
  'url' => 'https://github.com/libretro/snes9x2005/archive/1c9163ebabf1a5d454ff30221f7c735d7b286e25.tar.gz',
  'license' => 'Non-commercial',
  'platform' => 'unix',
  'submodules' => false,
  'build_type' => 'make',
  'makefile' => 'Makefile',
  'name' => 'snes9x2005',
  'repo' => 'libretro-snes9x2005',
  'build_dir' => '.',
  'extra_args' => [],
  'cmake_opts' => [],
  'so_file' => 'snes9x2005_libretro.so'
}

def add_minui_cores
  recipe_files = Dir['recipes/linux/*.yml']

  recipe_files.each do |recipe_file|
    cpu_family = File.basename(recipe_file, '.yml')
    puts "\nğŸ“ Processing #{cpu_family}..."

    # Load recipe (skip header, parse after ---)
    file_content = File.read(recipe_file)
    yaml_content = file_content.split('---', 2)[1]
    recipes = YAML.load(yaml_content) || {}
    added = []

    # Add supafaust if missing
    unless recipes.key?('supafaust')
      recipes['supafaust'] = SUPAFAUST.dup
      added << 'supafaust'
    end

    # Add snes9x2005 if missing
    unless recipes.key?('snes9x2005')
      recipes['snes9x2005'] = SNES9X2005.dup
      added << 'snes9x2005'
    end

    # Cross-platform cores: copy from existing recipe files if missing
    # mgba: copy from a53 to a7
    if cpu_family == 'cortex-a7' && !recipes.key?('mgba')
      # Reload a53 to get latest (may have been modified)
      a53_data = File.read('recipes/linux/cortex-a53.yml')
      a53_recipes = YAML.load(a53_data.split('---', 2)[1])
      if a53_recipes && a53_recipes['mgba']
        recipes['mgba'] = a53_recipes['mgba'].dup
        # Add note about Float128 compatibility
        recipes['mgba']['so_file'] = 'build/mgba_libretro.so'
        added << 'mgba (cross-platform compat)'
      end
    end

    # gpsp: copy from a7 to a53/a55/a76
    if cpu_family != 'cortex-a7' && !recipes.key?('gpsp')
      a7_data = File.read('recipes/linux/cortex-a7.yml')
      a7_recipes = YAML.load(a7_data.split('---', 2)[1])
      if a7_recipes && a7_recipes['gpsp']
        recipes['gpsp'] = a7_recipes['gpsp'].dup
        added << 'gpsp (cross-platform compat)'
      end
    end

    # pcsx: copy from a7 to a53/a55/a76
    if cpu_family != 'cortex-a7' && !recipes.key?('pcsx')
      a7_data = File.read('recipes/linux/cortex-a7.yml')
      a7_recipes = YAML.load(a7_data.split('---', 2)[1])
      if a7_recipes && a7_recipes['pcsx']
        recipes['pcsx'] = a7_recipes['pcsx'].dup
        added << 'pcsx (cross-platform compat)'
      end
    end

    # picodrive: copy from a7 to a53/a55/a76
    if cpu_family != 'cortex-a7' && !recipes.key?('picodrive')
      a7_data = File.read('recipes/linux/cortex-a7.yml')
      a7_recipes = YAML.load(a7_data.split('---', 2)[1])
      if a7_recipes && a7_recipes['picodrive']
        recipes['picodrive'] = a7_recipes['picodrive'].dup
        added << 'picodrive (cross-platform compat)'
      end
    end

    if added.empty?
      puts "  âœ“ All MinUI cores already present"
    else
      # Sort cores alphabetically
      recipes = recipes.sort.to_h

      # Write back with header
      header = File.read(recipe_file).split('---').first
      File.open(recipe_file, 'w') do |f|
        f.write(header)
        f.write("---\n")
        f.write(YAML.dump(recipes))
      end

      puts "  âœ“ Added #{added.size} cores: #{added.join(', ')}"
      puts "  ğŸ“Š Total cores: #{recipes.size}"
    end
  end

  puts "\nâœ… MinUI core integration complete!"
  puts "\nMinUI Required Cores (13 total):"
  puts "  âœ“ fake08, fceumm, gambatte, gpsp"
  puts "  âœ“ beetle-pce-fast (mednafen_pce_fast)"
  puts "  âœ“ supafaust (mednafen_supafaust)"
  puts "  âœ“ beetle-vb (mednafen_vb)"
  puts "  âœ“ mgba, pcsx (pcsx_rearmed)"
  puts "  âœ“ picodrive, pokemini, race"
  puts "  âœ“ snes9x2005 (snes9x2005_plus)"
end

# Run
add_minui_cores
