#!/usr/bin/env ruby
# frozen_string_literal: true

# Convert JSON recipe files to YAML format
# Usage: json-to-yaml <json-file>

require 'json'
require 'yaml'

def convert_json_to_yaml(json_file)
  unless File.exist?(json_file)
    puts "ERROR: File not found: #{json_file}"
    exit 1
  end

  # Read JSON
  data = JSON.parse(File.read(json_file))

  # Generate YAML filename
  yaml_file = json_file.sub(/\.json$/, '.yml')

  # Create header comment
  cpu_family = File.basename(json_file, '.json')
  header = <<~HEADER
    # LessUI-Cores Recipe File
    # CPU Family: #{cpu_family}
    #
    # This file is the source of truth for which cores to build.
    # It is manually maintained - edit directly to add/update/remove cores.
    #
    # To update a core from Knulli:
    #   1. Check knulli/package/batocera/emulators/retroarch/libretro/libretro-<core>.mk
    #   2. Find the _VERSION variable (git commit hash)
    #   3. Update the 'commit' and 'version' fields below
    #   4. Rebuild: make build-#{cpu_family}
    #
    # Core entry format:
    #   core-name:
    #     version: <git-commit-hash>
    #     commit: <git-commit-hash>
    #     url: <github-tarball-url>
    #     license: <license>
    #     platform: unix|<platform-specific>
    #     submodules: true|false
    #     build_type: make|cmake
    #     makefile: Makefile.libretro|Makefile|<path>
    #     name: <core-name>
    #     repo: <repo-name>
    #     build_dir: .|<subdir>
    #     extra_args: [<make-args>]           # Optional
    #     cmake_opts: [<cmake-options>]       # Optional (cmake only)
    #     so_file: <path-to-output.so>        # Optional (override default)

  HEADER

  # Write YAML
  File.open(yaml_file, 'w') do |f|
    f.write(header)
    f.write(YAML.dump(data))
  end

  puts "✓ Converted #{json_file} → #{yaml_file}"
  puts "  #{data.size} cores"
end

# Main
if ARGV.empty?
  puts "Usage: json-to-yaml <json-file> [<json-file> ...]"
  puts ""
  puts "Example:"
  puts "  json-to-yaml recipes/linux/*.json"
  exit 1
end

ARGV.each do |json_file|
  convert_json_to_yaml(json_file)
end

puts ""
puts "✓ Conversion complete!"
